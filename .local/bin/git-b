#!/bin/bash

# Branch switcher with fzf, sorted by most recent checkout
# Inspired by https://seb.jambor.dev/posts/improving-shell-workflows-with-fzf/

# Get branches with last checkout time from reflog
branches_with_time() {
    {
        git branch --format='%(refname:short)'
        echo "---END_BRANCHES---"
        git reflog --date=relative
    } | awk '
        /^---END_BRANCHES---$/ { in_reflog = 1; next }
        !in_reflog { exists[$0] = 1; next }
        /checkout: moving .* to / {
            time = $0
            sub(/.*HEAD@\{/, "", time)
            sub(/\}.*/, "", time)
            branch = $0
            sub(/.*checkout: moving .* to /, "", branch)
            if (!seen[branch]++ && (branch in exists)) {
                print branch " (" time ")"
                from_reflog[branch] = 1
            }
        }
        END {
            for (b in exists)
                if (!(b in from_reflog)) print b " (never)"
        }
    '
}

current=$(git branch --show-current)

prefix="${SAFEUSER:-$USER}/"
branch=$(branches_with_time |
    awk -F' \\(' '!seen[$1]++' |
    grep -v "^${current} " |
    PREFIX="$prefix" awk '{
        if (index($0, ENVIRON["PREFIX"]) == 1) {
            n = length(ENVIRON["PREFIX"])
            print "\033[33m" substr($0, 1, n) "\033[0m" substr($0, n+1)
        } else {
            print
        }
    }' |
    fzf --ansi --preview-window=bottom:40% --preview="git log -15 {1}")

if [[ -n "$branch" ]]; then
    # Strip the time suffix
    branch=$(echo "$branch" | sed 's/ (.*//')
    git checkout "$branch"
fi
